# Архитектура MongoDB с шардированием, репликацией и кешированием

## Описание архитектуры

Данный проект реализует высоконагруженную архитектуру для онлайн-магазина "Мобильный мир" с использованием:

### 🗄️ Шардирование MongoDB
- **2 шарда** для распределения нагрузки
- **Hashed sharding** по полю `name` для равномерного распределения данных
- **Config Server** (3 реплики) для хранения метаданных шардирования
- **Mongos Router** для маршрутизации запросов к шардам

### 🔄 Репликация MongoDB
- **3 реплики на каждый шард** для отказоустойчивости
- **Автоматический failover** при отказе primary реплики
- **Read preferences** для распределения нагрузки чтения

### ⚡ Кеширование Redis
- **Redis 7** для кеширования часто запрашиваемых данных
- **FastAPI Cache** с TTL 60 секунд для API эндпоинтов
- **Автоматическая инвалидация** кеша при изменениях

## Архитектурная схема

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Config Server │    │   Config Server │    │   Config Server │
│   (config1)     │    │   (config2)     │    │   (config3)     │
│   Port: 27019   │    │   Port: 27019   │    │   Port: 27019   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Mongos Router │
                    │   Port: 27017   │
                    └─────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Shard 1       │    │   Shard 2       │    │     Redis       │
│   Replica Set   │    │   Replica Set   │    │   Port: 6379    │
│   Port: 27018   │    │   Port: 27020   │    │                 │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │                 │
│ │ Primary     │ │    │ │ Primary     │ │    │                 │
│ │ Replica 1   │ │    │ │ Replica 1   │ │    │                 │
│ └─────────────┘ │    │ └─────────────┘ │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │                 │
│ │ Secondary   │ │    │ │ Secondary   │ │    │                 │
│ │ Replica 2   │ │    │ │ Replica 2   │ │    │                 │
│ └─────────────┘ │    │ └─────────────┘ │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │                 │
│ │ Secondary   │ │    │ │ Secondary   │ │    │                 │
│ │ Replica 3   │ │    │ │ Replica 3   │ │    │                 │
│ └─────────────┘ │    │ └─────────────┘ │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   FastAPI App   │
                    │   Port: 8080    │
                    └─────────────────┘
```

## Запуск системы

### 1. Запуск всех сервисов
```bash
docker compose up -d
```

### 2. Инициализация шардирования
```bash
chmod +x scripts/mongo-init.sh
./scripts/mongo-init.sh
```

### 3. Проверка статуса
```bash
# Автоматическая проверка всех компонентов
chmod +x scripts/check-status.sh
./scripts/check-status.sh

# Или ручная проверка:
# Проверка статуса шардирования
docker compose exec -T mongos mongosh --port 27017 --quiet <<EOF
sh.status()
EOF

# Проверка репликации
docker compose exec -T shard1_replica1 mongosh --port 27018 --quiet <<EOF
rs.status()
EOF
```

### 4. Тестирование производительности
```bash
# Запуск теста производительности
chmod +x scripts/load-test.sh
./scripts/load-test.sh
```

## API Endpoints

### Основные эндпоинты
- `GET /` - Информация о топологии MongoDB и статусе кеширования
- `GET /docs` - Swagger документация API
- `GET /{collection}/count` - Количество документов в коллекции
- `GET /{collection}/users` - Список пользователей (с кешированием)
- `GET /{collection}/users/{name}` - Получение пользователя по имени
- `POST /{collection}/users` - Создание нового пользователя

### Примеры запросов
```bash
# Получение информации о системе
curl http://localhost:8080/

# Получение количества документов
curl http://localhost:8080/helloDoc/count

# Получение списка пользователей (кешируется на 60 секунд)
curl http://localhost:8080/helloDoc/users

# Создание нового пользователя
curl -X POST http://localhost:8080/helloDoc/users \
  -H "Content-Type: application/json" \
  -d '{"name": "test_user", "age": 25}'
```

## Мониторинг и отладка

### Проверка статуса репликации
```bash
# Shard 1
docker compose exec -T shard1_replica1 mongosh --port 27018 --quiet <<EOF
rs.status()
EOF

# Shard 2
docker compose exec -T shard2_replica1 mongosh --port 27020 --quiet <<EOF
rs.status()
EOF
```

### Проверка распределения данных
```bash
# Проверка распределения документов по шардам
docker compose exec -T mongos mongosh --port 27017 --quiet <<EOF
use somedb
db.helloDoc.getShardDistribution()
EOF
```

### Проверка кеширования
```bash
# Проверка Redis
docker compose exec -T redis redis-cli ping
docker compose exec -T redis redis-cli info memory
```

## Преимущества архитектуры

### 🚀 Производительность
- **Шардирование** распределяет нагрузку между серверами
- **Кеширование** ускоряет доступ к часто запрашиваемым данным
- **Горизонтальное масштабирование** позволяет добавлять новые шарды

### 🛡️ Отказоустойчивость
- **Репликация** обеспечивает резервное копирование данных
- **Автоматический failover** при отказе primary реплики
- **Избыточность** на всех уровнях архитектуры

### 📈 Масштабируемость
- **Легкое добавление шардов** для увеличения производительности
- **Гибкая настройка** репликации и кеширования
- **Поддержка высоких нагрузок** при распродажах

## Технические детали

### Порты сервисов
- **Mongos Router**: 27017
- **Config Server**: 27019
- **Shard 1**: 27018
- **Shard 2**: 27020
- **Redis**: 6379
- **FastAPI**: 8080

### Настройки шардирования
- **Тип шардирования**: Hashed
- **Ключ шардирования**: `name`
- **Количество шардов**: 2
- **Реплик на шард**: 3

### Настройки кеширования
- **TTL**: 60 секунд
- **Backend**: Redis
- **Prefix**: `api:cache`
