#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
# –î–ª—è –ø—Ä–æ–µ–∫—Ç–∞ "–ú–æ–±–∏–ª—å–Ω—ã–π –º–∏—Ä" —Å Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "================================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API..."
if ! curl -s http://localhost:8080/ > /dev/null; then
    echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã: docker compose up -d"
    exit 1
fi
echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤..."
DOC_COUNT=$(curl -s http://localhost:8080/helloDoc/count | jq -r '.items_count')
echo "üìà –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: $DOC_COUNT"

if [ "$DOC_COUNT" -lt 1000 ]; then
    echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –º–µ–Ω—å—à–µ 1000. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é: ./scripts/mongo-init-repl.sh"
else
    echo "‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º (‚â•1000)"
fi

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
echo ""
echo "‚ö° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è..."
echo ""

# –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º)
echo "üîÑ –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫–µ—à–∞)..."
START_TIME=$(date +%s%N)
curl -s http://localhost:8080/helloDoc/users > /dev/null
END_TIME=$(date +%s%N)
FIRST_REQUEST_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
echo "‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${FIRST_REQUEST_TIME}–º—Å"

# –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
sleep 2

# –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä—ã–º –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–µ—à—É)
echo ""
echo "üîÑ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (—Å –∫–µ—à–µ–º)..."
START_TIME=$(date +%s%N)
curl -s http://localhost:8080/helloDoc/users > /dev/null
END_TIME=$(date +%s%N)
SECOND_REQUEST_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
echo "‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${SECOND_REQUEST_TIME}–º—Å"

# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
echo ""
echo "üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
echo "======================"

if [ "$SECOND_REQUEST_TIME" -lt 100 ]; then
    echo "‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è <100–º—Å (${SECOND_REQUEST_TIME}–º—Å)"
    echo "‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚ùå –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚â•100–º—Å (${SECOND_REQUEST_TIME}–º—Å)"
    echo "‚ùå –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
fi

SPEEDUP=$((FIRST_REQUEST_TIME / SECOND_REQUEST_TIME))
echo "üöÄ –£—Å–∫–æ—Ä–µ–Ω–∏–µ: –≤ ${SPEEDUP} —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis..."
if docker compose exec -T redis redis-cli ping > /dev/null 2>&1; then
    echo "‚úÖ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π
    CACHE_KEYS=$(docker compose exec -T redis redis-cli keys "api:cache:*" | wc -l)
    echo "üì¶ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π: $CACHE_KEYS"
    
    if [ "$CACHE_KEYS" -gt 0 ]; then
        echo "‚úÖ –ö–µ—à —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ"
    else
        echo "‚ö†Ô∏è  –ö–µ—à –ø—É—Å—Ç"
    fi
else
    echo "‚ùå Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
echo ""
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ..."
SYSTEM_INFO=$(curl -s http://localhost:8080/)
echo "üóÑÔ∏è  –¢–æ–ø–æ–ª–æ–≥–∏—è MongoDB: $(echo $SYSTEM_INFO | jq -r '.mongo_topology_type')"
echo "üîó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–¥–æ–≤: $(echo $SYSTEM_INFO | jq -r '.shards | length')"
echo "‚ö° –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ: $(echo $SYSTEM_INFO | jq -r '.cache_enabled')"

echo ""
echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üí° –î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:"
echo "   - Swagger UI: http://localhost:8080/docs"
echo "   - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã: http://localhost:8080/"
echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: ./scripts/check-status.sh" 